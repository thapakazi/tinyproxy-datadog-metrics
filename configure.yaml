---
### generated by chatgpt
###
#
# ansible-pull -U https://github.com/thapakazi/tinyproxy-datadog-metrics configure.yaml -i "localhost," -c local
#
###
- name: Configure tinyproxy and Datadog
  hosts: all
  vars:
    datadog_api_key: 'xxx'

  tasks:
    - name: Install Datadog Agent
      ansible.builtin.shell: >
        DD_AGENT_MAJOR_VERSION=7 DD_API_KEY={{ datadog_api_key }} DD_SITE="datadoghq.com" bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/scripts/install_script.sh)"

    - name: Clone tinyproxy-datadog-metrics repository
      ansible.builtin.git:
        repo: https://github.com/thapakazi/tinyproxy-datadog-metrics.git
        dest: /tmp/dd

    - name: Copy stats.json to /usr/share/tinyproxy
      ansible.builtin.copy:
        src: /tmp/dd/stats.json
        dest: /usr/share/tinyproxy/stats.json

    - name: Update tinyproxy configuration
      ansible.builtin.lineinfile:
        path: /etc/tinyproxy/tinyproxy.conf
        regexp: '^StatFile(.*)'
        line: 'StatFile "/usr/share/tinyproxy/stats.json"'

    - name: Copy tinyproxy.py to /etc/datadog-agent/checks.d/
      ansible.builtin.copy:
        src: /tmp/dd/tinyproxy.py
        dest: /etc/datadog-agent/checks.d/

    - name: Copy tinyproxy.yaml to /etc/datadog-agent/conf.d/
      ansible.builtin.copy:
        src: /tmp/dd/tinyproxy.yaml
        dest: /etc/datadog-agent/conf.d/

    - name: Restart Tinyproxy
      ansible.builtin.systemd:
        name: tinyproxy
        state: restarted

    - name: Restart Datadog Agent
      ansible.builtin.systemd:
        name: datadog-agent
        state: restarted



